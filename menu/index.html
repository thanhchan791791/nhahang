<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Nhà Hàng Cao Cấp - iOS Style</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải Lottie cho animation thành công -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
    <!-- Tải Font Inter (thay thế SF Pro) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Định nghĩa màu accent mới: Deep Slate Gray & Muted Brass */
        :root {
            --color-accent: #1E1E1E; /* Deep Slate Gray cho CTA/Primary */
            --color-highlight: #A38E6D; /* Muted Brass cho Price/Secondary highlight */
            --color-accent-dark: #000000; 
            --color-shadow-light: rgba(0, 0, 0, 0.05);
            --color-shadow-heavy: rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F8F8; /* Nền trắng tinh tế */
            color: #1a1a1a;
            -webkit-tap-highlight-color: transparent;
        }

        /* Tùy chỉnh Tailwind CSS để sử dụng màu accent mới */
        .tailwind-config-override {
            --tw-ring-color: var(--color-accent);
        }

        /* Hiệu ứng iOS Card */
        .ios-card {
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            box-shadow: 0 4px 12px var(--color-shadow-light);
            border-radius: 24px; /* Bo tròn lớn */
            background-color: white;
            will-change: transform, box-shadow;
        }
        .ios-card:hover, .ios-card.active-tap {
            transform: translateY(-4px);
            box-shadow: 0 8px 18px var(--color-shadow-heavy);
        }

        /* Giỏ hàng (Drawer) */
        .cart-drawer {
            transition: transform 0.4s cubic-bezier(0.3, 0.7, 0.4, 1.5);
            transform: translateY(100%);
        }
        .cart-drawer.open {
            transform: translateY(0);
        }

        /* Nút Stepper */
        .stepper-btn {
            transition: transform 0.1s ease-out, background-color 0.1s;
        }
        .stepper-btn:active {
            transform: scale(0.9);
        }

        /* Loading Skeleton */
        .skeleton {
            background-color: #e2e2e2;
            background: linear-gradient(90deg, #e2e2e2 25%, #f0f0f0 50%, #e2e2e2 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Fly to Cart Animation */
        #fly-clone {
            position: fixed;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: all 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* iOS-like Active Tab Underline */
        .tab-item {
            position: relative;
            transition: color 0.3s ease-in-out;
        }
        .tab-item::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: transparent;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: scaleX(0);
        }
        /* Sử dụng màu accent cho underline */
        .tab-item.active::after {
            background-color: var(--color-accent);
            transform: scaleX(1);
        }
        
        /* CSS cho Floating Cart Bubble (FAB) */
        #floating-cart-bubble {
            box-shadow: 0 6px 15px rgba(163, 142, 109, 0.4); /* Shadow nhẹ nổi bật */
            border: 2px solid white; /* Viền trắng tinh tế */
        }
        
        /* Hiệu ứng rung nhẹ khi có món mới */
        @keyframes subtle-shake {
            0%, 100% { transform: scale(1) translate(0, 0); }
            20%, 60% { transform: scale(1.05) translate(-1px, 1px); }
            40%, 80% { transform: scale(1.05) translate(1px, -1px); }
        }
        .bubble-shake {
            animation: subtle-shake 0.4s ease-in-out;
        }
    </style>
</head>
<body class="tailwind-config-override">
    <div id="app" class="max-w-xl mx-auto min-h-screen relative p-4 pb-32">
        <!-- 1. Header (Thanh điều hướng) -->
        <header class="flex justify-center items-center py-4 sticky top-0 bg-[#F8F8F8] z-30">
            <div class="flex-1 text-center">
                <span class="text-2xl font-extrabold tracking-widest text-gray-800">THE</span>
                <span class="text-2xl font-extralight text-gray-800" style="color: var(--color-highlight);">MENU</span>
            </div>
            <!-- Đã loại bỏ icon giỏ hàng khỏi Header -->
        </header>

        <!-- 2. Danh mục (Tabs) -->
        <div class="sticky top-16 z-20 bg-[#F8F8F8] pb-4">
            <div id="category-tabs" class="flex overflow-x-scroll no-scrollbar space-x-4 pb-2">
                <!-- Tabs được tạo bởi JS -->
            </div>
        </div>

        <!-- 3. Danh sách món ăn -->
        <div id="menu-list" class="grid grid-cols-2 gap-4 mt-2">
            <!-- Menu Cards được tạo bởi JS hoặc Skeleton Loader -->
        </div>

        <!-- Nút Giỏ Hàng Nổi (Kiểu Bong Bóng Chat/FAB) -->
        <button id="floating-cart-bubble" 
                class="fixed bottom-6 right-6 z-50 p-4 rounded-full text-white shadow-xl flex items-center space-x-2 transition-all duration-300 scale-0 origin-bottom-right" 
                style="background-color: var(--color-highlight);"
                onclick="toggleCart(true)">
            <svg id="cart-svg-bubble" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span id="bubble-item-count" class="font-bold text-sm">0</span>
        </button>

        <!-- Animation Clone (Bay vào giỏ hàng) -->
        <div id="fly-clone" style="background-color: var(--color-accent);"></div>

        <!-- 4. Giỏ hàng (Cart Drawer - iOS Style Modal) -->
        <div id="cart-drawer" class="cart-drawer fixed inset-x-0 bottom-0 bg-white z-40 rounded-t-3xl shadow-2xl max-h-[85vh] flex flex-col">
            <div class="p-4 border-b border-gray-100 relative">
                <button onclick="toggleCart(false)" class="absolute left-4 top-1/2 transform -translate-y-1/2 p-2 rounded-full hover:bg-gray-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 class="text-xl font-bold text-center">Giỏ Hàng Của Bạn</h2>
            </div>
            
            <!-- Danh sách món trong giỏ -->
            <div id="cart-items-list" class="flex-1 overflow-y-auto p-4 space-y-4">
                <p id="empty-cart-message" class="text-center text-gray-500 mt-10">Giỏ hàng trống.</p>
                <!-- Items -->
            </div>

            <!-- Thanh tổng kết cố định -->
            <div id="cart-summary" class="p-4 bg-white border-t-2 border-gray-100 shadow-inner">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-semibold text-gray-500">Tổng cộng:</span>
                    <span id="cart-total" class="text-2xl font-extrabold" style="color: var(--color-accent);">0đ</span>
                </div>
                <button id="checkout-button" class="w-full text-white font-bold py-3 px-4 rounded-full text-lg shadow-lg opacity-50 cursor-not-allowed" 
                        style="background-color: var(--color-accent); transition: all 0.3s ease-in-out;"
                        disabled
                        onclick="openCheckoutModal()">
                    Đặt món ngay
                </button>
            </div>
        </div>

        <!-- 5. Checkout Modal -->
        <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-end justify-center transition-opacity duration-300 opacity-0 pointer-events-none">
            <div id="checkout-drawer" class="bg-white w-full max-w-xl rounded-t-3xl p-6 transform translate-y-full transition-transform duration-300 ease-in-out">
                <h2 class="text-2xl font-bold text-center mb-6">Thông Tin Đặt Món</h2>
                <form id="checkout-form" onsubmit="handleCheckout(event)">
                    <div class="space-y-4">
                        <input type="text" id="customer-name" placeholder="Tên khách hàng" required 
                               class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-gray-800 transition duration-200 focus:outline-none">
                        <input type="tel" id="customer-phone" placeholder="Số điện thoại" required 
                               class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-gray-800 transition duration-200 focus:outline-none">
                        <textarea id="customer-note" placeholder="Ghi chú (Ví dụ: Số bàn, yêu cầu đặc biệt)" 
                                  class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-gray-800 transition duration-200 focus:outline-none h-24"></textarea>
                    </div>
                    <button type="submit" class="mt-6 w-full text-white font-bold py-4 rounded-full text-lg shadow-xl"
                            style="background-color: var(--color-accent); transition: background-position 0.5s ease-in-out, transform 0.1s ease-out; background-size: 200% auto;"
                            onmousedown="this.style.transform='scale(0.98)'"
                            onmouseup="this.style.transform='scale(1)'"
                            onmouseleave="this.style.transform='scale(1)'">
                        Xác nhận Đặt Món (Tổng: <span id="checkout-summary-total">0đ</span>)
                    </button>
                    <button type="button" onclick="closeCheckoutModal()" class="w-full text-gray-500 mt-2 p-2">Hủy</button>
                </form>
            </div>
        </div>

        <!-- 6. Success Popup (Confetti Animation) -->
        <div id="success-popup" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
            <div class="bg-white p-8 rounded-3xl text-center shadow-2xl transform scale-90 transition-transform duration-300" style="width: 300px;">
                <div id="lottie-checkmark" class="w-32 h-32 mx-auto"></div>
                <h3 class="text-2xl font-extrabold mt-4" style="color: var(--color-accent);">Đặt Món Thành Công!</h3>
                <p class="text-gray-600 mt-2">Đơn hàng của quý khách đang được chuẩn bị. Xin cảm ơn!</p>
                <button onclick="closeSuccessPopup()" class="mt-6 w-full py-3 rounded-full text-white font-semibold" 
                        style="background-color: var(--color-accent); transition: transform 0.1s;">
                    Hoàn tất
                </button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK & Script -->
    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // --- Cấu hình và Khởi tạo Firebase ---
        const firebaseConfig = {
            // SỬ DỤNG CẤU HÌNH CỦA BẠN TỪ FILE GỐC
            apiKey: "AIzaSyAV7r-rjXo6U62LX1AA7c7DAHb8GhOOOsg",
            authDomain: "saigon-dalat.firebaseapp.com",
            databaseURL: "https://saigon-dalat-default-rtdb.firebaseio.com",
            projectId: "saigon-dalat",
            storageBucket: "saigon-dalat.firebasestorage.app",
            messagingSenderId: "339735183485",
            appId: "1:339735183485:web:bc23cd740104d272577114",
            measurementId: "G-FDLZXR2X8P"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Biến State Cần Thiết ---
        let menuData = {};    // Dữ liệu thô từ Firebase
        let flatMenuData = {}; // Dữ liệu phẳng để tra cứu nhanh bằng ID
        let cartItems = {};    // { itemId: { item, quantity } }
        let categories = {};   // Danh mục động (chỉ bao gồm drink và food nếu có)
        let activeCategory = '';

        // --- Helpers ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount).replace('₫', 'đ');
        };

        const getCartTotal = () => {
            return Object.values(cartItems).reduce((sum, item) => sum + item.item.price * item.quantity, 0);
        };

        const sendOrderToDB = (order) => {
            const ordersRef = ref(db, 'orders/' + Date.now());
            set(ordersRef, order)
                .then(() => console.log("✅ Order đã được ghi lên Realtime DB."))
                .catch(error => console.error("❌ Lỗi ghi Order:", error));
        };

        // --- Lifecycle và Data Loading (CHỈ LOAD TỪ FIREBASE) ---

        function initData() {
            renderSkeleton(); // Hiển thị Skeleton UI khi khởi tạo

            // Lắng nghe dữ liệu Menu chính
            onValue(ref(db, "menu"), (snapshot) => {
                const data = snapshot.val();
                
                // 1. Chỉ lấy data từ Firebase và ánh xạ sang key chuẩn
                menuData = {};
                if (data?.drink && Object.keys(data.drink).length > 0) {
                    menuData.drinks = data.drink;
                }
                if (data?.food && Object.keys(data.food).length > 0) {
                    menuData.foods = data.food;
                }

                // 2. Tạo categories động
                categories = {};
                                if (menuData.foods) categories.foods = { label: ' Món ăn' };

                if (menuData.drinks) categories.drinks = { label: ' Đồ uống' };
                
                // 3. Chuẩn hóa và gộp data (Flattening)
                flatMenuData = {};
                let firstCategory = '';
                Object.keys(menuData).forEach(catKey => {
                    if (!firstCategory) firstCategory = catKey;
                    const items = menuData[catKey];
                    Object.keys(items).forEach(id => {
                        flatMenuData[id] = { id: id, ...items[id], categoryKey: catKey };
                    });
                });
                
                // 4. Thiết lập category active đầu tiên
                if (!activeCategory || !categories[activeCategory]) {
                     activeCategory = firstCategory || '';
                }

                renderTabs();
                renderMenu();
                
                // CẬP NHẬT: Gọi renderCart sau khi menu tải xong để UI giỏ hàng được đồng bộ
                renderCart(); 

                const appElement = document.getElementById('app');
                if (appElement) {
                    appElement.classList.remove('loading-state');
                }
            });
        }

        // --- Render Functions ---

        const renderSkeleton = () => {
             const menuList = document.getElementById('menu-list');
             if (!menuList) return;
             
             menuList.innerHTML = '';
             for (let i = 0; i < 6; i++) {
                 menuList.innerHTML += `
                    <div class="ios-card overflow-hidden h-64 flex flex-col">
                        <div class="skeleton w-full h-3/5 rounded-t-2xl"></div>
                        <div class="p-3 space-y-2 flex-1 flex flex-col justify-between">
                            <div class="skeleton h-5 w-3/4 rounded-md"></div>
                            <div class="flex justify-between items-center">
                                <div class="skeleton h-6 w-1/3 rounded-md"></div>
                                <div class="skeleton w-10 h-10 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                `;
             }
        }
        
        const renderTabs = () => {
            const tabsContainer = document.getElementById('category-tabs');
            if (!tabsContainer) return;
            
            tabsContainer.innerHTML = '';
            
            Object.keys(categories).forEach(key => {
                const isActive = key === activeCategory;
                const tabHtml = `
                    <button data-category="${key}" onclick="setActiveCategory('${key}')" 
                            class="tab-item px-4 py-2 text-lg font-semibold whitespace-nowrap ${isActive ? 'active text-gray-900 font-bold' : 'text-gray-500 font-medium'}"
                            style="transition: all 0.3s;">
                        ${categories[key].label}
                    </button>
                `;
                tabsContainer.innerHTML += tabHtml;
            });
            
            // Cuộn đến tab đang active
            const activeTab = tabsContainer.querySelector(`.tab-item[data-category="${activeCategory}"]`);
            if (activeTab) {
                 activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        };

        window.setActiveCategory = (key) => {
            activeCategory = key;
            renderTabs();
            renderMenu();
        };

        window.renderMenu = () => {
            const menuList = document.getElementById('menu-list');
            if (!menuList) return;

            menuList.innerHTML = '';
            const items = menuData[activeCategory] || {};
            
            if (Object.keys(items).length === 0) {
                 menuList.innerHTML = `<p class="col-span-2 text-center text-gray-500 py-10">Hiện tại không có món nào trong danh mục này.</p>`;
                 return;
            }

            Object.keys(items).forEach(id => {
                const item = flatMenuData[id];
                // Sử dụng placeholder image nếu không có URL
                const imageUrl = item.img && item.img.startsWith('http') 
                                 ? item.img 
                                 : 'https://placehold.co/1000x800/E5E7EB/6B7280?text=LUXURY+FOOD';

                const cardHtml = `
                    <div id="item-${id}" class="ios-card overflow-hidden flex flex-col cursor-pointer" 
                         ontouchstart="this.classList.add('active-tap')" ontouchend="this.classList.remove('active-tap')" 
                         onmouseleave="this.classList.remove('active-tap')">
                        <!-- Ảnh món ăn -->
                        <div class="w-full h-[60%] overflow-hidden rounded-t-2xl">
                             <img src="${imageUrl}" 
                                  onerror="this.onerror=null;this.src='https://placehold.co/1000x800/E5E7EB/6B7280?text=Luxury+Food';" 
                                  class="w-full h-full object-cover transition duration-300 transform hover:scale-105" alt="${item.name}">
                        </div>
                        
                        <!-- Thông tin món ăn -->
                        <div class="p-4 flex flex-col justify-between flex-1">
                            <h3 class="text-base font-extrabold line-clamp-2 leading-snug mb-2 text-gray-900">${item.name}</h3>
                            <div class="flex justify-between items-center">
                                <span class="text-xl font-light" style="color: var(--color-highlight);">${formatCurrency(item.price)}</span>
                                <button onclick="event.stopPropagation(); addItemToCart('${id}')" 
                                        class="w-10 h-10 flex items-center justify-center rounded-full text-white shadow-md transition duration-150 transform hover:scale-110 active:scale-90"
                                        style="background-color: var(--color-accent);">
                                    +
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                menuList.innerHTML += cardHtml;
            });
        };

        window.renderCart = () => {
            try {
                const cartList = document.getElementById('cart-items-list');
                const cartTotalElement = document.getElementById('cart-total');
                const checkoutSummaryTotal = document.getElementById('checkout-summary-total');
                const emptyMessage = document.getElementById('empty-cart-message');
                const checkoutButton = document.getElementById('checkout-button');
                
                // Cập nhật cho FAB (Bubble)
                const floatingBubble = document.getElementById('floating-cart-bubble');
                const bubbleCount = document.getElementById('bubble-item-count');

                if (!cartList) return; 

                cartList.innerHTML = '';
                const total = getCartTotal();
                const itemCount = Object.values(cartItems).reduce((sum, item) => sum + item.quantity, 0);

                // Cập nhật Floating Bubble
                if (floatingBubble && bubbleCount) {
                    bubbleCount.textContent = itemCount;
                    // Hiển thị FAB khi có món, ẩn khi trống
                    floatingBubble.classList.toggle('scale-100', itemCount > 0);
                    floatingBubble.classList.toggle('scale-0', itemCount === 0);
                }
                
                // Cập nhật Tổng tiền
                if (cartTotalElement) {
                    cartTotalElement.textContent = formatCurrency(total);
                }
                if (checkoutSummaryTotal) {
                    checkoutSummaryTotal.textContent = formatCurrency(total);
                }

                // Ẩn/Hiện thông báo Giỏ hàng trống
                if (emptyMessage) {
                    emptyMessage.classList.toggle('hidden', itemCount > 0);
                }
                
                // Cập nhật nút Checkout
                if (checkoutButton) {
                    if (itemCount === 0) {
                        checkoutButton.disabled = true;
                        checkoutButton.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        checkoutButton.disabled = false;
                        checkoutButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }

                Object.keys(cartItems).forEach(id => {
                    const cartItem = cartItems[id];
                    const item = cartItem.item;
                    const itemTotal = item.price * cartItem.quantity;

                    const imageUrl = item.img && item.img.startsWith('http') 
                                     ? item.img 
                                     : 'https://placehold.co/100x100/E5E7EB/6B7280?text=Food';
                    
                    const itemHtml = `
                        <div class="flex items-center p-3 bg-gray-50 rounded-2xl shadow-sm transition duration-300 hover:bg-gray-100">
                            <!-- Ảnh nhỏ -->
                            <img src="${imageUrl}" 
                                 class="w-16 h-16 object-cover rounded-xl mr-4">
                            
                            <!-- Chi tiết -->
                            <div class="flex-1 min-w-0">
                                <p class="font-bold truncate text-sm">${item.name}</p>
                                <p class="text-sm font-light text-gray-700">${formatCurrency(itemTotal)}</p>
                            </div>

                            <!-- Stepper -->
                            <div class="flex items-center space-x-2 border border-gray-200 rounded-full p-1 ml-4">
                                <button class="stepper-btn w-6 h-6 flex items-center justify-center rounded-full bg-white text-gray-500" 
                                        onclick="updateCartQuantity('${id}', -1)">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                                </button>
                                <span class="font-medium text-sm w-4 text-center">${cartItem.quantity}</span>
                                <button class="stepper-btn w-6 h-6 flex items-center justify-center rounded-full text-white" 
                                        style="background-color: var(--color-accent);"
                                        onclick="updateCartQuantity('${id}', 1)">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    cartList.innerHTML += itemHtml;
                });
            } catch (error) {
                console.error("Lỗi khi render Cart:", error);
            }
        };

        // --- Cart Actions ---
        
        window.addItemToCart = (id) => {
            const item = flatMenuData[id];
            
            if (cartItems[id]) {
                cartItems[id].quantity += 1;
            } else {
                cartItems[id] = { item: item, quantity: 1 };
            }

            // Animation cho Floating Bubble
            const floatingBubble = document.getElementById('floating-cart-bubble');
            if (floatingBubble) {
                // Thêm class lắc nhẹ khi món ăn được thêm vào
                floatingBubble.classList.add('bubble-shake');
                setTimeout(() => floatingBubble.classList.remove('bubble-shake'), 500);
            }

            // Fly-to-cart animation
            const itemCard = document.getElementById(`item-${id}`);
            if (itemCard) {
                const button = itemCard.querySelector('button');
                const cartIcon = document.getElementById('floating-cart-bubble'); // Thay đổi target thành FAB
                
                if (button && cartIcon) {
                    const startRect = button.getBoundingClientRect();
                    const cartRect = cartIcon.getBoundingClientRect();

                    const flyClone = document.getElementById('fly-clone');
                    // Khởi tạo vị trí clone từ nút '+'
                    flyClone.style.top = `${startRect.top}px`;
                    flyClone.style.left = `${startRect.left}px`;
                    flyClone.style.width = `${startRect.width}px`;
                    flyClone.style.height = `${startRect.height}px`;
                    flyClone.style.opacity = 1;
                    flyClone.style.transform = 'scale(1)';

                    // Bắt đầu bay về giỏ hàng
                    setTimeout(() => {
                        // Tính toán vị trí tâm của FAB
                        flyClone.style.top = `${cartRect.top + cartRect.height / 2 - 20}px`;
                        flyClone.style.left = `${cartRect.left + cartRect.width / 2 - 20}px`;
                        flyClone.style.width = '40px';
                        flyClone.style.height = '40px';
                        flyClone.style.opacity = 0.5;
                        flyClone.style.transform = 'scale(0.3)';
                    }, 50);

                    // Hoàn tất bay
                    setTimeout(() => {
                        flyClone.style.opacity = 0;
                        flyClone.style.transform = 'scale(1)';
                        flyClone.style.width = '0px';
                        flyClone.style.height = '0px';
                        renderCart(); // Cập nhật giỏ hàng sau khi animation kết thúc
                    }, 750);
                } else {
                     renderCart();
                }
            } else {
                 renderCart();
            }
        };
        
        window.updateCartQuantity = (id, change) => {
            if (!cartItems[id]) return;

            const newQuantity = cartItems[id].quantity + change;
            
            if (newQuantity <= 0) {
                delete cartItems[id];
            } else {
                cartItems[id].quantity = newQuantity;
            }
            renderCart();
        };

        window.toggleCart = (open) => {
            const drawer = document.getElementById('cart-drawer');
            if (!drawer) return;

            if (open) {
                // Chỉ mở giỏ hàng nếu có món
                if (Object.keys(cartItems).length > 0) {
                    renderCart();
                    drawer.classList.add('open');
                } else {
                    console.log("Giỏ hàng trống, không mở drawer.");
                }
            } else {
                drawer.classList.remove('open');
            }
        };

        // --- Checkout & Success Logic ---

        window.openCheckoutModal = () => {
            toggleCart(false);
            const modal = document.getElementById('checkout-modal');
            const drawer = document.getElementById('checkout-drawer');
            
            if (!modal || !drawer) return;

            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                drawer.classList.remove('translate-y-full');
                modal.classList.add('opacity-100');
            }, 10);
        };
        
        window.closeCheckoutModal = () => {
            const modal = document.getElementById('checkout-modal');
            const drawer = document.getElementById('checkout-drawer');
            
            if (!modal || !drawer) return;

            drawer.classList.add('translate-y-full');
            modal.classList.remove('opacity-100');
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
            }, 300);
        };

        window.handleCheckout = (event) => {
            event.preventDefault();
            
            const customerName = document.getElementById('customer-name')?.value;
            const customerPhone = document.getElementById('customer-phone')?.value;
            const customerNote = document.getElementById('customer-note')?.value;
            const orderTotal = getCartTotal();

            const orderDetails = Object.values(cartItems).map(ci => ({
                id: ci.item.id,
                name: ci.item.name,
                price: ci.item.price,
                quantity: ci.quantity
            }));
            
            const finalOrder = {
                customer: {
                    name: customerName,
                    phone: customerPhone,
                    note: customerNote
                },
                items: orderDetails,
                total: orderTotal,
                timestamp: new Date().toISOString()
            };
            
            console.log("Đang gửi Order:", finalOrder);
            sendOrderToDB(finalOrder);

            // Reset state
            cartItems = {};
            const checkoutForm = document.getElementById('checkout-form');
            if (checkoutForm) {
                 checkoutForm.reset();
            }
            closeCheckoutModal();
            renderCart();

            showSuccessPopup();
        };

        window.showSuccessPopup = () => {
            const popup = document.getElementById('success-popup');
            const lottieContainer = document.getElementById('lottie-checkmark');
            
            if (!popup || !lottieContainer) return;

            popup.classList.remove('opacity-0', 'pointer-events-none');
            popup.querySelector('div')?.classList.remove('scale-90');
            
            // Lottie Animation (Mock Checkmark)
            const anim = lottie.loadAnimation({
                container: lottieContainer,
                renderer: 'svg',
                loop: false,
                autoplay: true,
                animationData: {
                    v: "5.7.4",
                    nm: "Checkmark",
                    assets: [],
                    layers: [
                        {
                            ddd: 0, ind: 0, ty: 4, nm: "Check", sr: 1,
                            ks: {
                                o: { a: 0, k: 100 },
                                p: { a: 0, k: [100, 100, 0] },
                                s: { a: 0, k: [100, 100, 100] }
                            },
                            shapes: [
                                { ty: "gr", nm: "Group 1", it: [
                                    { d: 1, ty: "sh", path: { k: { i: [[0, 0], [0, 0], [0, 0]], o: [[0, 0], [0, 0], [0, 0]], v: [[50, 50], [70, 70], [90, 30]] } } },
                                    // Sử dụng màu accent cho checkmark
                                    { ty: "st", c: { a: 0, k: [30/255, 30/255, 30/255, 1] }, w: { a: 0, k: 8 }, lc: 2, lj: 1 },
                                    { ty: "tr", a: { a: 0, k: [0, 0] }, p: { a: 0, k: [0, 0] }, s: { a: 0, k: [100, 100] } }
                                ]}
                            ]
                        }
                    ],
                    w: 200, h: 200, fr: 30, ip: 0, op: 60
                }
            });

            // Tự động đóng sau 3 giây
            setTimeout(() => {
                closeSuccessPopup();
                anim.destroy();
            }, 3000);
        };

        window.closeSuccessPopup = () => {
             const popup = document.getElementById('success-popup');
             if (!popup) return;
             popup.classList.add('opacity-0', 'pointer-events-none');
             popup.querySelector('div')?.classList.add('scale-90');
        };

        // --- Khởi chạy Ứng dụng ---
        document.addEventListener('DOMContentLoaded', initData);

        // Đảm bảo không có horizontal scroll trên các màn hình nhỏ
        document.addEventListener('scroll', () => {
             const tabsContainer = document.getElementById('category-tabs');
             if (tabsContainer) {
                 // Không cần thiết logic cuộn/shadow phức tạp cho ví dụ này, chỉ để lại đây nếu cần thiết
             }
        });
    </script>
</body>
</html>
