<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ẩm thực Buôn Mê - Premium Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary-color: #3E2723;
            --gold-accent: #C69C6D;
            --bg-creme: #FAF9F6;
            --ios-blur: rgba(255, 255, 255, 0.85);
            --header-height: 80px;
            --sidebar-width: 110px;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* HIỆU ỨNG LOADING BAN ĐẦU */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-creme);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #E0E0E0;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: 1px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* HIỆU ỨNG LOAD TỪ TRÊN XUỐNG CHO ITEM */
        .food-item {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* KHÓA CUỘN NGANG TUYỆT ĐỐI */
        html, body {
            height: 100vh;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden !important;
            position: fixed;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-creme);
            color: #2C1B18;
        }

        /* --- HEADER --- */
        .restaurant-header {
            height: var(--header-height);
            background: var(--ios-blur);
            backdrop-filter: blur(25px) saturate(200%);
            -webkit-backdrop-filter: blur(25px) saturate(200%);
            display: flex;
            align-items: center;
            padding: 0 15px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1100;
            border-bottom: 1px solid rgba(62, 39, 35, 0.08);
        }

        .restaurant-logo {
            height: 40px; width: 40px;
            object-fit: contain; border-radius: 10px; margin-right: 12px;
        }

        .restaurant-name {
            font-weight: 900; font-size: 1.2rem;
            color: var(--primary-color); margin: 0;
            letter-spacing: -0.5px; text-transform: uppercase;
        }

        /* --- LAYOUT --- */
        .order-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            padding-top: var(--header-height);
            padding-bottom: var(--safe-area-bottom);
        }

        .sidebar {
            width: var(--sidebar-width);
            flex-shrink: 0;
            background: #F2EFE9;
            overflow-y: auto;
            scrollbar-width: none;
            border-right: 1px solid rgba(62, 39, 35, 0.05);
            padding: 10px 5px;
        }
        .sidebar::-webkit-scrollbar { display: none; }

        .sidebar-group-label {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--primary-color);
            text-align: center;
            letter-spacing: 0.5px;
            margin: 25px 0 12px;
            text-transform: uppercase;
            padding-bottom: 5px;
            border-bottom: 2px solid rgba(198, 156, 109, 0.3);
        }

        .nav-link {
            padding: 12px 8px;
            margin-bottom: 8px;
            color: #8D736B;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 14px;
            transition: all 0.3s ease;
            line-height: 1.2;
            border: 1px solid transparent;
            position: relative;
        }

        .nav-link.active {
            background: #FFFFFF !important;
            color: var(--primary-color) !important;
            font-weight: 900 !important;
            box-shadow: 0 8px 15px rgba(62, 39, 35, 0.1);
            transform: scale(1.05);
            border: 1px solid rgba(198, 156, 109, 0.2);
        }

        .bestseller-icon {
            position: absolute;
            top: -2px;
            right: 4px;
            font-size: 0.8rem;
            color: #FF4D4D;
            filter: drop-shadow(0 0 2px rgba(255, 77, 77, 0.4));
        }

        /* --- CONTENT --- */
        .menu-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            padding: 0 15px;
            -webkit-overflow-scrolling: touch;
        }

        .category-header {
            position: relative;
            font-weight: 900;
            font-size: 1.6rem;
            color: var(--primary-color);
            letter-spacing: -1px;
            margin: 25px 0 15px;
            padding-top: 10px;
        }

        /* HIỂN THỊ DỌC */
        .food-item {
            display: flex;
            flex-direction: column; 
            padding: 10px;
            background: #fff;
            border-radius: 20px;
            margin-bottom: 15px;
            box-shadow: 0 6px 15px rgba(62, 39, 35, 0.04);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .food-item:active { transform: scale(0.96); background: #FDFCFB; }

        .food-img { 
            width: 100%; 
            aspect-ratio: 1 / 1; 
            object-fit: contain; 
            background: #f8f8f8; 
            border-radius: 15px; 
            margin-bottom: 10px;
        }
        
        .food-detail { 
            flex: 1; 
            padding: 0 5px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            min-width: 0; 
        }
        
        .food-name { font-weight: 700; font-size: 1.05rem; color: #2D1B18; margin-bottom: 4px; }
        .food-price { color: var(--primary-color); font-weight: 800; font-size: 1.1rem; }

        .item-badge {
            position: absolute; top: 15px; right: 15px;
            background: var(--gold-accent); color: white;
            font-size: 0.75rem; padding: 3px 10px; border-radius: 12px;
            font-weight: 800; display: none;
            z-index: 10;
        }

        /* --- POPUP CHUNG --- */
        .custom-popup {
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, 100%) scale(0.8);
            width: 90%; max-width: 400px; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 35px; z-index: 3000; padding: 25px; 
            opacity: 0; pointer-events: none;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: 0 25px 60px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.4);
        }
        .custom-popup.show { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
        
        .modal-img { 
            width: 100%; 
            height: auto; 
            max-height: 300px; 
            object-fit: contain; 
            background: #f8f8f8;
            border-radius: 25px; 
            margin-bottom: 15px; 
        }
        .modal-name { font-weight: 900; font-size: 1.4rem; color: var(--primary-color); margin-bottom: 5px; }
        .modal-price { color: var(--gold-accent); font-weight: 800; font-size: 1.2rem; margin-bottom: 15px; }
        
        .note-input {
            width: 100%; border: 1px solid #EEE; border-radius: 15px; padding: 12px;
            font-size: 0.9rem; margin-top: 15px; background: #F9F9F9; outline: none;
        }

        .alert-icon { font-size: 3rem; color: var(--gold-accent); margin-bottom: 15px; }
        .alert-title { font-weight: 900; font-size: 1.2rem; color: var(--primary-color); margin-bottom: 10px; line-height: 1.4; }

        /* --- FLY ANIMATION --- */
        .fly-dot {
            position: fixed; width: 25px; height: 25px;
            background: var(--gold-accent); border-radius: 50%;
            z-index: 9999; pointer-events: none;
            box-shadow: 0 0 15px var(--gold-accent);
            transition: all 0.8s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        /* --- CART ICON --- */
        .footer-cart-icon {
            position: fixed; bottom: calc(25px + var(--safe-area-bottom));
            right: 20px; width: 60px; height: 60px;
            background: var(--primary-color); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 2000;
            opacity: 0; transform: translateY(100px);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .footer-cart-icon.visible { opacity: 1; transform: translateY(0); }

        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .footer-cart-icon.bump { animation: bounce 0.4s ease-out; }

        .cart-badge {
            position: absolute; top: -2px; right: -2px;
            background: var(--gold-accent); color: white;
            font-weight: 800; font-size: 0.75rem;
            min-width: 22px; height: 22px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--primary-color);
        }

        /* --- ORDER SHEET --- */
        .order-sheet {
            position: fixed; bottom: -100%; left: 0; right: 0;
            background: #fff; border-radius: 30px 30px 0 0;
            z-index: 2100; padding: 20px;
            padding-bottom: calc(20px + var(--safe-area-bottom));
            max-height: 80vh; overflow-y: auto;
            transition: bottom 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .order-sheet.open { bottom: 0; }
        .sheet-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 2050; display: none; }

        .quantity-control { display: flex; align-items: center; background: #F5F3F0; border-radius: 20px; padding: 3px; gap: 15px; }
        .btn-circle { width: 35px; height: 35px; border-radius: 50%; border: none; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-confirm-order { width: 100%; background: var(--primary-color); color: #fff; border: none; padding: 16px; border-radius: 18px; font-weight: 800; margin-top: 15px; }
        
        .cart-item-row { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #F5F5F5; }

        #success-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.4s; }
        #success-overlay.show { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="loader-spinner"></div>
    <div class="loading-text">ẨM THỰC BUÔN MÊ ĐANG TẢI...</div>
</div>

<div class="restaurant-header">
    <img src="logobanme.png" alt="Logo" class="restaurant-logo" onerror="this.src='https://via.placeholder.com/100?text=BM'">
    <h1 class="restaurant-name">Ẩm thực Buôn Mê</h1>
</div>

<div class="order-container">
    <div class="sidebar">
        <div class="nav flex-column" id="category-list" role="tablist"></div>
    </div>
    <div class="menu-content" id="main-menu" data-bs-spy="scroll" data-bs-target="#category-list" data-bs-offset="100" tabindex="0"></div>
</div>

<div class="custom-popup" id="monThemAlert">
    <div class="text-center">
        <div class="alert-icon"><i class="bi bi-info-circle-fill"></i></div>
        <div class="alert-title">Lưu ý: Các món này chỉ gọi thêm khi bạn đã đặt 'Mẹt tổng hợp nhiều món'.</div>
        <div style="font-size: 0.95rem; color: #666; margin-bottom: 25px;">Bạn có chắc chắn muốn tiếp tục order món này không?</div>
        <div class="d-flex gap-2">
            <button class="btn-confirm-order" style="background: #EEE; color: #333; flex: 1; margin-top:0;" onclick="closeMonThemAlert()">Hủy</button>
            <button class="btn-confirm-order" style="flex: 1; margin-top:0;" id="btn-confirm-monthem">Tiếp tục</button>
        </div>
    </div>
</div>

<div class="custom-popup" id="itemModal">
    <img id="modal-img" class="modal-img" src="">
    <div id="modal-name" class="modal-name"></div>
    <div id="modal-price" class="modal-price"></div>
    
    <div class="d-flex justify-content-between align-items-center">
        <span style="font-weight: 600;">Số lượng:</span>
        <div class="quantity-control">
            <button class="btn-circle" onclick="changeModalQty(-1)">−</button>
            <span id="modal-qty" style="font-weight: 800; font-size: 1.1rem;">1</span>
            <button class="btn-circle" style="background:var(--primary-color); color:white" onclick="changeModalQty(1)">+</button>
        </div>
    </div>
    
    <textarea id="modal-note" class="note-input" placeholder="Ghi chú thêm (VD: Không hành, cay vừa...)"></textarea>
    
    <div class="d-flex gap-2 mt-4">
        <button class="btn-confirm-order" style="background: #EEE; color: #333; flex: 1; margin-top:0;" onclick="closeModal()">Đóng</button>
        <button class="btn-confirm-order" style="flex: 2; margin-top:0;" id="btn-add-to-cart">Thêm vào giỏ</button>
    </div>
</div>

<div class="footer-cart-icon" id="cartIcon" onclick="toggleCart()">
    <i class="bi bi-bag-heart-fill" style="color:white; font-size:1.5rem;"></i>
    <div class="cart-badge" id="total-count-badge">0</div>
</div>

<div class="sheet-overlay" id="overlay" onclick="handleOverlayClick()"></div>
<div class="order-sheet" id="orderSheet">
    <div style="width:40px; height:4px; background:#DDD; border-radius:10px; margin:0 auto 15px;"></div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 style="font-weight: 800; color: #3E2723; margin: 0;">Giỏ hàng</h4>
        <span onclick="toggleCart()" style="color: #C69C6D; font-weight: 700;">Đóng</span>
    </div>
    <div id="cart-list"></div>
    <div id="sheet-footer-ui" style="display:none; margin-top:20px; border-top:1px solid #EEE;">
        <div class="d-flex justify-content-between align-items-center mt-3">
            <span style="font-weight: 600; color: #888;">Tổng cộng:</span>
            <span id="total-price" style="font-size: 1.4rem; font-weight: 900; color: var(--primary-color);">0đ</span>
        </div>
        <button class="btn-confirm-order" id="btn-main-submit" onclick="submitOrder()">ĐẶT MÓN NGAY</button>
    </div>
</div>

<div id="success-overlay">
    <i class="bi bi-check-circle-fill" style="font-size: 5rem; color: var(--primary-color);"></i>
    <h2 style="font-weight: 900; margin-top: 20px;">Gửi đơn thành công!</h2>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAV7r-rjXo6U62LX1AA7c7DAHb8GhOOOsg",
        authDomain: "saigon-dalat.firebaseapp.com",
        databaseURL: "https://saigon-dalat-default-rtdb.firebaseio.com",
        projectId: "saigon-dalat",
        storageBucket: "saigon-dalat.firebasestorage.app",
        messagingSenderId: "339735183485",
        appId: "1:339735183485:web:bc23cd740104d272577114"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let masterMenu = {};
    let cart = {};
    let lastTotalCount = 0;
    let currentModalItem = null;

    function getTableFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        let table = urlParams.get('table');
        if (!table && window.location.hash) {
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash);
            table = hashParams.get('table');
        }
        return table || "Khong xac dinh";
    }
    const tableNumber = getTableFromURL();

    const TELEGRAM_TOKEN = "8581857488:AAGFtZdA3NecouzR8YaJsH0eVKEFlGZ2fB0";
    const TELEGRAM_CHAT_ID = "-5038976521";

    const foodLabels = { 
        "monmoi": "Món mới",
        "4mon": "Món phải thử", 
        "7mon": "Món nên trải nghiệm", 
        "metTongHop": "Mẹt tổng hợp nhiều món", 
        "monCanh": "Món Canh", 
        "monChinh": "Món Chính", 
        "monRau": "Món Rau", 
        "monthemmet": "Món Thêm",
        "trangmieng": "Tráng Miệng" 
    };
    const drinkLabels = { "coCon": "Đồ Có Cồn", "giaiKhat": "Giải Khát", "kem": "Kem", "nuocEp": "Nước Ép" };

    onValue(ref(db, '/'), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        masterMenu = { ...data.menu.food, ...data.menu.drink };
        renderFullMenu(data.menuGroups, data.menu);
        
        // KHI DỮ LIỆU TỪ FIREBASE ĐÃ LOAD XONG, ẨN LOADING
        hideLoading();
    });

    function hideLoading() {
        const loader = document.getElementById('loading-screen');
        if(loader) {
            loader.style.opacity = '0';
            loader.style.visibility = 'hidden';
            setTimeout(() => loader.remove(), 600);
        }
    }

    function renderFullMenu(groups, menuData) {
        const sidebar = document.getElementById('category-list');
        const mainMenu = document.getElementById('main-menu');
        sidebar.innerHTML = ''; mainMenu.innerHTML = '';
        sidebar.innerHTML += '<div class="sidebar-group-label">Thực đơn</div>';
        renderCategoryGroup(groups.food, menuData.food, foodLabels, sidebar, mainMenu);
        sidebar.innerHTML += '<div class="sidebar-group-label">Thức uống</div>';
        renderCategoryGroup(groups.drink, menuData.drink, drinkLabels, sidebar, mainMenu);
        
        setTimeout(() => { 
            new bootstrap.ScrollSpy(document.getElementById('main-menu'), { 
                target: '#category-list', 
                offset: 120 
            }); 
            setupSmoothScroll();
        }, 500);
    }

    function setupSmoothScroll() {
        const links = document.querySelectorAll('.nav-link');
        const container = document.getElementById('main-menu');
        
        links.forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                const targetEl = document.getElementById(targetId);
                
                if (targetEl) {
                    const offsetTop = targetEl.offsetTop - 10;
                    container.scrollTo({
                        top: offsetTop,
                        behavior: 'smooth'
                    });
                }
            };
        });
    }

    function renderCategoryGroup(groups, details, labels, sidebarEl, contentEl) {
        let globalIndex = 0; // Dùng để tạo hiệu ứng delay so le
        Object.keys(labels).forEach(catId => {
            if (groups && groups[catId]) {
                let sectionContent = ''; let hasValid = false;
                Object.keys(groups[catId]).forEach(itemId => {
                    const info = details[itemId];
                    if (info && info.name && info.name.toLowerCase().includes("(cay)")) return; 
                    if (info && info.imageUrl && info.imageUrl.trim() !== "" && info.status !== "sold-out") {
                        hasValid = true;
                        globalIndex++;
                        sectionContent += `
                        <div class="food-item" style="animation-delay: ${globalIndex * 0.05}s" onclick="openItemModal(event, '${itemId}', '${catId}')">
                            <div class="item-badge" id="badge-${itemId}">0</div>
                            <img src="${info.imageUrl}" class="food-img" loading="lazy">
                            <div class="food-detail">
                                <div class="food-name">${info.name}</div>
                                <div class="food-price">${info.price.toLocaleString()}đ</div>
                            </div>
                        </div>`;
                    }
                });
                if (hasValid) {
                    let bestSellerHtml = (catId === 'metTongHop' || catId === 'nuocEp' || catId === 'monmoi') ? '<i class="bi bi-star-fill bestseller-icon"></i>' : '';
                    sidebarEl.innerHTML += `<a class="nav-link" href="#cat-${catId}">${bestSellerHtml}${labels[catId]}</a>`;
                    contentEl.innerHTML += `<div id="cat-${catId}" class="menu-section"><div class="category-header">${labels[catId]}</div>${sectionContent}</div>`;
                }
            }
        });
    }

    window.openItemModal = (e, id, categoryId) => {
        const item = masterMenu[id];
        currentModalItem = { id, ...item, qty: 1, clickEvent: e };
        if (categoryId === 'monthemmet') {
            document.getElementById('monThemAlert').classList.add('show');
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('btn-confirm-monthem').onclick = () => {
                document.getElementById('monThemAlert').classList.remove('show');
                showDetailModal();
            };
        } else {
            showDetailModal();
        }
    };

    function showDetailModal() {
        const item = currentModalItem;
        document.getElementById('modal-img').src = item.imageUrl;
        document.getElementById('modal-name').innerText = item.name;
        document.getElementById('modal-price').innerText = item.price.toLocaleString() + 'đ';
        document.getElementById('modal-qty').innerText = '1';
        document.getElementById('modal-note').value = '';
        document.getElementById('itemModal').classList.add('show');
        document.getElementById('overlay').style.display = 'block';

        document.getElementById('btn-add-to-cart').onclick = () => {
            const qty = currentModalItem.qty;
            const note = document.getElementById('modal-note').value;
            animateFly(currentModalItem.clickEvent);
            updateCart(item.id, qty, item.price, note);
            closeModal();
        };
    }

    window.closeMonThemAlert = () => {
        document.getElementById('monThemAlert').classList.remove('show');
        document.getElementById('overlay').style.display = 'none';
    };

    window.closeModal = () => {
        document.getElementById('itemModal').classList.remove('show');
        if (!document.getElementById('orderSheet').classList.contains('open')) {
            document.getElementById('overlay').style.display = 'none';
        }
    };

    window.changeModalQty = (delta) => {
        currentModalItem.qty = Math.max(1, currentModalItem.qty + delta);
        document.getElementById('modal-qty').innerText = currentModalItem.qty;
    };

    window.handleOverlayClick = () => {
        closeModal();
        closeMonThemAlert();
        toggleCart(false);
    };

    window.updateCart = (id, delta, price, note = "") => {
        if (!cart[id]) cart[id] = { qty: 0, price: price, name: masterMenu[id]?.name || id, note: "" };
        cart[id].qty += delta;
        if (note) cart[id].note = note;
        if (cart[id].qty <= 0) delete cart[id];
        const b = document.getElementById(`badge-${id}`);
        if(b) { b.innerText = cart[id]?.qty || 0; b.style.display = cart[id]?.qty > 0 ? 'block' : 'none'; }
        updateTotalUI();
    };

    function updateTotalUI() {
        let total = 0, count = 0;
        let listHtml = '';
        Object.keys(cart).forEach(id => { 
            const item = cart[id];
            total += (item.qty * item.price); count += item.qty;
            listHtml += `<div class="cart-item-row"><div style="flex:1"><div style="font-weight:700; color:#3E2723">${item.name}</div>${item.note ? `<div style="font-size:0.75rem; color:#888; font-style:italic">Ghi chú: ${item.note}</div>` : ''}<div style="color:#C69C6D; font-size:0.9rem">${(item.qty * item.price).toLocaleString()}đ</div></div><div class="quantity-control"><div class="btn-circle" onclick="updateCart('${id}', -1, ${item.price})">−</div><span style="font-weight:800; min-width:20px; text-align:center;">${item.qty}</span><div class="btn-circle" style="background:var(--primary-color); color:white" onclick="updateCart('${id}', 1, ${item.price})">+</div></div></div>`;
        });
        const icon = document.getElementById('cartIcon');
        if (count > lastTotalCount) { icon.classList.remove('bump'); void icon.offsetWidth; icon.classList.add('bump'); }
        lastTotalCount = count;
        if (count > 0) { icon.classList.add('visible'); document.getElementById('total-count-badge').innerText = count; document.getElementById('sheet-footer-ui').style.display = 'block'; } else { icon.classList.remove('visible'); document.getElementById('sheet-footer-ui').style.display = 'none'; toggleCart(false); }
        document.getElementById('total-price').innerText = total.toLocaleString() + 'đ';
        document.getElementById('cart-list').innerHTML = listHtml || '<p style="text-align:center; opacity:0.4; margin-top:20px;">Giỏ hàng đang trống</p>';
    }

    window.animateFly = (e) => {
        if (!e) return;
        const dot = document.createElement('div');
        dot.className = 'fly-dot';
        dot.style.left = e.clientX + 'px'; dot.style.top = e.clientY + 'px';
        document.body.appendChild(dot);
        setTimeout(() => { const rect = document.getElementById('cartIcon').getBoundingClientRect(); dot.style.left = (rect.left + 20) + 'px'; dot.style.top = (rect.top + 20) + 'px'; dot.style.transform = 'scale(0.2)'; dot.style.opacity = '0'; }, 10);
        setTimeout(() => dot.remove(), 800);
    };

    window.toggleCart = (force) => {
        const sheet = document.getElementById('orderSheet');
        const overlay = document.getElementById('overlay');
        if (force === false) { sheet.classList.remove('open'); overlay.style.display = 'none'; return; }
        sheet.classList.toggle('open');
        overlay.style.display = sheet.classList.contains('open') ? 'block' : 'none';
    };

    async function sendTelegramMessage(cartData) {
        let message = `BAN: ${tableNumber}\n`;
        Object.keys(cartData).forEach((id, index) => {
            const item = cartData[id];
            message += `${index + 1}. ${item.name} (x${item.qty})\n`;
            if(item.note) message += `- Ghi chu: ${item.note}\n`;
            message += "\n";
        });
        message += "------------------";
        const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
        try { await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message }) }); } catch (error) { console.error("Loi gui Telegram:", error); }
    }

    window.submitOrder = async () => {
        const btn = document.getElementById('btn-main-submit');
        btn.disabled = true; btn.innerText = "Dang gui...";
        await sendTelegramMessage(cart);
        toggleCart(false);
        const success = document.getElementById('success-overlay');
        success.classList.add('show');
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#C69C6D', '#3E2723'] });
        setTimeout(() => location.reload(), 3000);
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
